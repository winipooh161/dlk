import"./index.esm2017-NZQW5Whv.js";import{s as x}from"./firebase-init-DU03lT4B.js";document.addEventListener("DOMContentLoaded",()=>{if("Notification"in window&&Notification.permission!=="granted"&&Notification.permission!=="denied"){const e=document.createElement("div");e.className="notification-permission-banner",e.innerHTML=`
            <div class="notification-banner-content">
                <p>–†–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                <button id="allow-notifications" class="btn btn-primary">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
                <button id="close-notification-banner" class="btn btn-secondary">–ü–æ–∑–∂–µ</button>
            </div>
        `,document.body.appendChild(e),document.getElementById("allow-notifications").addEventListener("click",()=>{Notification.requestPermission().then(n=>{console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "+(n==="granted"?"—Ä–∞–∑—Ä–µ—à–∏–ª":"–Ω–µ —Ä–∞–∑—Ä–µ—à–∏–ª")+" —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"),e.remove()})}),document.getElementById("close-notification-banner").addEventListener("click",()=>{e.remove()})}const w=window.Laravel.user.id,d=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),M=window.pinImgUrl,_=window.unpinImgUrl,O=window.deleteImgUrl;let c=null,r=null,L=new Set,y=!1,j=new Set;function H(e){const n=e.parentElement,t=document.createElement("button"),s=document.createElement("div");t.textContent="üòâ",t.type="button",t.classList.add("emoji-button"),s.classList.add("emoji-picker"),s.style.position="absolute",s.style.bottom="50px",s.style.left="10px";const o=["üòÄ","üòÅ","üòÇ","ü§£","üòÉ","üòÑ","üòÖ","üòÜ","üòâ","üòä","üòç","üòò","üòú","üòé","üò≠","üò°","üòá","üòà","üôÉ","ü§î","üò•","üòì","ü§©","ü•≥","ü§Ø","ü§¨","ü§°","üëª","üíÄ","üëΩ","ü§ñ","üéÉ","üê±","üê∂","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","ü¶Å","üêÆ","üê∑","üê∏","üêµ","üêî","üêß","üê¶","üåπ","üåª","üå∫","üå∑","üåº","üçé","üçì","üçí","üçá","üçâ","üçã","üçä","üçå","ü•ù","üçç","ü•≠"];let i="";o.forEach(a=>{i+=`<span class="emoji-item">${a}</span>`}),s.innerHTML=i,s.addEventListener("click",a=>{if(a.target.classList.contains("emoji-item")){const $=a.target.textContent,g=e.selectionStart,b=e.value.substring(0,g),l=e.value.substring(g);e.value=b+$+l;const p=g+$.length;e.selectionStart=p,e.selectionEnd=p,e.focus()}}),n.appendChild(t),n.appendChild(s),s.style.display="none",t.addEventListener("click",a=>{a.stopPropagation(),s.style.display=s.style.display==="none"?"flex":"none"}),document.addEventListener("click",a=>{!s.contains(a.target)&&!t.contains(a.target)&&(s.style.display="none")})}function C(e){return new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function S(e){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,t=>n[t])}function P(){const e=document.getElementById("chat-messages");e.scrollTop=e.scrollHeight}function E(){document.querySelectorAll("#chat-messages ul li").forEach(e=>{e.style.display=y?e.classList.contains("pinned")?"":"none":""})}function k(e,n){const s=document.getElementById("chat-messages").querySelector("ul");let o="";e.forEach(i=>{if(!L.has(i.id)){if(i.message_type==="notification"||i.is_system)o+=`
                        <li class="system-notification" data-id="${i.id}">
                            ${i.message}
                            <span class="message-time">${C(i.created_at)}</span>
                        </li>
                    `;else{const a=i.sender_id===n,$=i.message_type==="notification"?"notification-message":a?"my-message":"other-message",g=i.is_pinned?"pinned":"";let b="";a&&i.is_read&&(b='<span class="read-status">‚úì‚úì</span>');let l="";i.message&&i.message.trim()!==""&&(i.message_type==="notification"?l+=i.message:l+=`<div>${S(i.message)}</div>`),i.attachments&&Array.isArray(i.attachments)&&i.attachments.length>0&&i.attachments.forEach(u=>{u&&u.mime&&u.mime.startsWith("image/")?l+=`<div><img src="${u.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:u&&u.url&&(l+=`<div><a href="${u.url}" target="_blank">${S(u.original_file_name||"–§–∞–π–ª")}</a></div>`)}),l.trim()===""&&(l='<div style="color:#888;">[–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]</div>');let p="";a&&(p=`
                            <div class="message-controls">
                                <button class="delete-message" data-id="${i.id}"><img src="${O}" alt="–£–¥–∞–ª–∏—Ç—å"></button>
                                ${i.is_pinned?`<button class="unpin-message" data-id="${i.id}"><img src="${_}" alt="–û—Ç–∫—Ä–µ–ø–∏—Ç—å"></button>`:`<button class="pin-message" data-id="${i.id}"><img src="${M}" alt="–ó–∞–∫—Ä–µ–ø–∏—Ç—å"></button>`}
                            </div>
                        `),o+=`
                        <li class="${$} ${g}" data-id="${i.id}">
                            <div><strong>${a?"–í—ã":S(i.sender_name||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")}</strong></div>
                            ${l}
                            ${p}
                            <span class="message-time">${C(i.created_at)}</span>
                            ${b}
                        </li>
                    `}L.add(i.id)}}),o&&(s.insertAdjacentHTML("beforeend",o),P(),F(),E())}function F(){document.querySelectorAll(".delete-message").forEach(e=>{e.onclick=function(){const n=this.getAttribute("data-id");confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")&&fetch(`/chats/${r}/${c}/messages/${n}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":d,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{t.success?this.closest("li").remove():alert(t.error||"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è")}).catch(t=>console.error("–û—à–∏–±–∫–∞:",t))}}),document.querySelectorAll(".pin-message").forEach(e=>{e.onclick=function(){const n=this.getAttribute("data-id");fetch(`/chats/${r}/${c}/messages/${n}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":d,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${_}" alt="–û—Ç–∫—Ä–µ–ø–∏—Ç—å">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let s=this.closest("li");if(s.classList.add("pinned"),s&&!s.querySelector(".pinned-label")){let o=document.createElement("span");o.classList.add("pinned-label"),o.textContent=" [–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ]",s.querySelector("div").appendChild(o)}E()}else alert(t.error||"–û—à–∏–±–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è")}).catch(t=>console.error("–û—à–∏–±–∫–∞:",t))}}),document.querySelectorAll(".unpin-message").forEach(e=>{e.onclick=function(){const n=this.getAttribute("data-id");fetch(`/chats/${r}/${c}/messages/${n}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":d,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${M}" alt="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let s=this.closest("li");s.classList.remove("pinned");let o=s.querySelector(".pinned-label");o&&o.remove(),E()}else alert(t.error||"–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è")}).catch(t=>console.error("–û—à–∏–±–∫–∞:",t))}})}function q(e,n){c=e,r=n;const s=document.getElementById("chat-messages").querySelector("ul");s.innerHTML="",L.clear();const o=document.querySelector(`[data-chat-id="${e}"][data-chat-type="${n}"] h5`),i=document.getElementById("chat-header");i.textContent=o?o.textContent:"–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è",fetch(`/chats/${n}/${e}/messages`).then(a=>{if(!a.ok)throw new Error("Network response was not ok");return a.json()}).then(a=>{k(a.messages,w),A(e,n)}).catch(a=>{console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:",a)})}function I(){if(!c||!h.value.trim()&&!document.querySelector(".file-input").files[0])return;const e=h.value.trim(),t=document.querySelector(".file-input").files;let s=new FormData;s.append("message",e);for(let o=0;o<t.length;o++)s.append("files[]",t[o]);fetch(`/chats/${r}/${c}/messages`,{method:"POST",headers:{"X-CSRF-TOKEN":d},body:s}).then(o=>o.ok?o.json():o.text().then(i=>{throw new Error(i)})).then(o=>{o.message&&(k([o.message],o.message.sender_id),h.value="",document.querySelector(".file-input").value="")}).catch(o=>console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:",o))}function A(e,n){fetch(`/chats/${n}/${e}/mark-read`,{method:"POST",headers:{"X-CSRF-TOKEN":d}}).catch(t=>console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:",t))}function R(){fetch("/chats/unread-counts",{method:"GET",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":d}}).then(e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()}).then(e=>{e.unread_counts&&e.unread_counts.length>0&&e.unread_counts.forEach(n=>{if(n.unread_count>0&&!j.has(n.id)){const t=`–£ –≤–∞—Å ${n.unread_count} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ ${n.name}`;x("–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",t,{chatId:n.id,chatType:n.type}),j.add(n.id)}})}).catch(e=>console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:",e))}setInterval(R,5e3);const m=document.getElementById("chat-list");m&&m.addEventListener("click",e=>{const n=e.target.closest("li");if(!n)return;const t=n.getAttribute("data-chat-id"),s=n.getAttribute("data-chat-type");c===t&&r===s||q(t,s)});const v=document.getElementById("search-chats"),f=document.getElementById("search-results");v&&v.addEventListener("input",function(){const e=v.value.trim().toLowerCase();e===""?(f.style.display="none",Array.from(m.children).forEach(n=>{n.style.display="flex"})):(Array.from(m.children).forEach(n=>{const t=n.querySelector("h5").textContent.toLowerCase();n.style.display=t.includes(e)?"flex":"none"}),fetch("/chats/search",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":d},body:JSON.stringify({query:e})}).then(n=>n.json()).then(n=>{let t="";n.chats&&n.chats.length>0&&(t+="<h5>–ß–∞—Ç—ã</h5><ul>",n.chats.forEach(s=>{t+=`<li data-chat-id="${s.id}" data-chat-type="${s.type}">${s.name}</li>`}),t+="</ul>"),n.messages&&n.messages.length>0&&(t+="<h5>–°–æ–æ–±—â–µ–Ω–∏—è</h5><ul>",n.messages.forEach(s=>{let o=s.chat_id,i="group";o||(i="personal",o=s.sender_id==w?s.receiver_id:s.sender_id),t+=`<li data-chat-id="${o}" data-chat-type="${i}" data-message-id="${s.id}">
                                <strong>${s.sender_name}:</strong> ${s.message.substring(0,50)}...
                                <br><small>${C(s.created_at)}</small>
                            </li>`}),t+="</ul>"),f.innerHTML=t,f.style.display=t.trim()===""?"none":"block",Array.from(f.querySelectorAll("li")).forEach(s=>{s.addEventListener("click",function(){const o=this.getAttribute("data-chat-id"),i=this.getAttribute("data-chat-type"),a=this.getAttribute("data-message-id");q(o,i),v.value="",f.style.display="none",a&&setTimeout(()=>{},1e3)})})}).catch(n=>console.error("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:",n)))});function B(){const e=document.querySelector(".attach-file"),n=document.querySelector(".file-input");e&&n&&(e.addEventListener("click",()=>{n.click()}),n.addEventListener("change",()=>{n.files.length>0&&I()}))}document.readyState!=="loading"?B():document.addEventListener("DOMContentLoaded",B);const N=document.getElementById("send-message"),h=document.getElementById("chat-message");N&&N.addEventListener("click",I),h&&h.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),I())}),H(h),document.addEventListener("DOMContentLoaded",()=>{const e=m?m.querySelector("li"):null;e&&e.click()}),setInterval(()=>{if(c&&r){const n=document.getElementById("chat-messages").querySelector("ul");fetch(`/chats/${r}/${c}/new-messages`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":d},body:JSON.stringify({last_message_id:n.lastElementChild?parseInt(n.lastElementChild.getAttribute("data-id")):0})}).then(t=>{if(!t.ok)throw new Error("Network response was not ok");return t.json()}).then(t=>{t.messages&&(k(t.messages,t.current_user_id),A(c,r))}).catch(t=>{console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:",t)})}},1e3),document.addEventListener("click",function(e){if(e.target.matches(".notification-message a[data-message-id]")){e.preventDefault();const n=e.target.dataset.messageId,t=document.querySelector(`li[data-id="${n}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.style.backgroundColor="#007ab6",setTimeout(()=>{t.style.backgroundColor=""},2e3))}});const T=document.getElementById("toggle-pinned");T&&T.addEventListener("click",()=>{y=!y,T.textContent=y?"–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è":"–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ",E()})});
