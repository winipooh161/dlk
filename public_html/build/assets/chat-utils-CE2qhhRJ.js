function b(s,i,l){document.querySelectorAll(".delete-message").forEach(r=>{r.onclick=function(){const c=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${i}/${l}/messages/${c}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":s,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{t.success?this.closest("li").remove():alert(t.error||"Ошибка удаления сообщения")}).catch(t=>console.error("Ошибка:",t))}}),document.querySelectorAll(".pin-message").forEach(r=>{r.onclick=function(){const c=this.getAttribute("data-id");fetch(`/chats/${i}/${l}/messages/${c}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":s,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let n=this.closest("li");if(n.classList.add("pinned"),n&&!n.querySelector(".pinned-label")){let a=document.createElement("span");a.classList.add("pinned-label"),a.textContent=" [Закреплено]",n.querySelector("div").appendChild(a)}filterMessages()}else console.error("Ошибка закрепления сообщения:",t.error),alert(t.error||"Ошибка закрепления сообщения")}).catch(t=>{console.error("Ошибка при закреплении сообщения:",t)})}}),document.querySelectorAll(".unpin-message").forEach(r=>{r.onclick=function(){const c=this.getAttribute("data-id");fetch(`/chats/${i}/${l}/messages/${c}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":s,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let n=this.closest("li");n.classList.remove("pinned");let a=n.querySelector(".pinned-label");a&&a.remove(),filterMessages()}else alert(t.error||"Ошибка открепления сообщения")}).catch(t=>console.error("Ошибка:",t))}})}function $(s){return new Date(s).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function p(s){const i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return s.replace(/[&<>"']/g,l=>i[l])}function L(){const s=document.getElementById("chat-messages");s.scrollTop=s.scrollHeight}function E(s){document.querySelectorAll("#chat-messages ul li").forEach(i=>{i.style.display=s?i.classList.contains("pinned")?"":"none":""})}function S(s,i,l,r,c,t){const n=document.getElementById("chat-messages");if(!n){console.error("Элемент chat-messages не найден!");return}const a=n.querySelector("ul");if(!a){console.error("Список сообщений не найден в chat-messages!");return}let m="",h=!1;s.forEach(e=>{if(!l.has(e.id)){if(h=!0,e.message_type==="notification"||e.is_system)m+=`
                    <li class="system-notification" data-id="${e.id}">
                        ${e.message}
                        <span class="message-time">${$(e.created_at)}</span>
                    </li>
                `;else{const u=e.sender_id===i,y=e.message_type==="notification"?"notification-message":u?"my-message":"other-message",v=e.is_pinned?"pinned":"";let f="";u&&e.is_read&&(f='<span class="read-status">✓✓</span>');let d="";e.message&&e.message.trim()!==""&&(e.message_type==="notification"?d+=e.message:d+=`<div>${p(e.message)}</div>`),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&e.attachments.forEach(o=>{o&&o.mime&&o.mime.startsWith("image/")?d+=`<div><img src="${o.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:o&&o.url&&(d+=`<div><a href="${o.url}" target="_blank">${p(o.original_file_name||"Файл")}</a></div>`)}),d.trim()===""&&(d='<div style="color:#888;">[Пустое сообщение]</div>');let g="";u&&(g=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${e.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${e.is_pinned?`<button class="unpin-message" data-id="${e.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${e.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),m+=`
                    <li class="${y} ${v}" data-id="${e.id}">
                        <div><strong>${u?"Вы":p(e.sender_name||"Неизвестно")}</strong></div>
                        ${d}
                        ${g}
                        <span class="message-time">${$(e.created_at)}</span>
                        ${f}
                    </li>
                `}l.add(e.id)}}),m&&h&&(a.insertAdjacentHTML("beforeend",m),L(),b(r,c,t),E())}export{E as a,$ as f,S as r};
