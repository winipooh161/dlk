import{u as y,r as E}from"./firebase-init-BVv5jLoC.js";function L(t,n,s){document.querySelectorAll(".delete-message").forEach(o=>{o.onclick=function(){const l=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${n}/${s}/messages/${l}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{i.success?this.closest("li").remove():alert(i.error||"Ошибка удаления сообщения")}).catch(i=>console.error("Ошибка:",i))}}),document.querySelectorAll(".pin-message").forEach(o=>{o.onclick=function(){const l=this.getAttribute("data-id");fetch(`/chats/${n}/${s}/messages/${l}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{if(i.success){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let a=this.closest("li");if(a.classList.add("pinned"),a&&!a.querySelector(".pinned-label")){let c=document.createElement("span");c.classList.add("pinned-label"),c.textContent=" [Закреплено]",a.querySelector("div").appendChild(c)}filterMessages()}else console.error("Ошибка закрепления сообщения:",i.error),alert(i.error||"Ошибка закрепления сообщения")}).catch(i=>{console.error("Ошибка при закреплении сообщения:",i)})}}),document.querySelectorAll(".unpin-message").forEach(o=>{o.onclick=function(){const l=this.getAttribute("data-id");fetch(`/chats/${n}/${s}/messages/${l}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(i=>i.json()).then(i=>{if(i.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let a=this.closest("li");a.classList.remove("pinned");let c=a.querySelector(".pinned-label");c&&c.remove(),filterMessages()}else alert(i.error||"Ошибка открепления сообщения")}).catch(i=>console.error("Ошибка:",i))}})}function $(t){return new Date(t).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function f(t){const n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,s=>n[s])}function S(){const t=document.getElementById("chat-messages");t.scrollTop=t.scrollHeight}function T(t){document.querySelectorAll("#chat-messages ul li").forEach(n=>{n.style.display=t?n.classList.contains("pinned")?"":"none":""})}function A(t,n,s,o,l,i){const a=document.getElementById("chat-messages");if(!a){console.error("Элемент chat-messages не найден!");return}const c=a.querySelector("ul");if(!c){console.error("Список сообщений не найден в chat-messages!");return}let m="",p=!1;t.forEach(e=>{if(!s.has(e.id)){if(p=!0,e.message_type==="notification"||e.is_system)m+=`
                    <li class="system-notification" data-id="${e.id}">
                        ${e.message}
                        <span class="message-time">${$(e.created_at)}</span>
                    </li>
                `;else{const u=e.sender_id===n,b=e.message_type==="notification"?"notification-message":u?"my-message":"other-message",v=e.is_pinned?"pinned":"";let h="";u&&e.is_read&&(h='<span class="read-status">✓✓</span>');let d="";e.message&&e.message.trim()!==""&&(e.message_type==="notification"?d+=e.message:d+=`<div>${f(e.message)}</div>`),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&e.attachments.forEach(r=>{r&&r.mime&&r.mime.startsWith("image/")?d+=`<div><img src="${r.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:r&&r.url&&(d+=`<div><a href="${r.url}" target="_blank">${f(r.original_file_name||"Файл")}</a></div>`)}),d.trim()===""&&(d='<div style="color:#888;">[Пустое сообщение]</div>');let g="";u&&(g=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${e.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${e.is_pinned?`<button class="unpin-message" data-id="${e.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${e.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),m+=`
                    <li class="${b} ${v}" data-id="${e.id}">
                        <div><strong>${u?"Вы":f(e.sender_name||"Неизвестно")}</strong></div>
                        ${d}
                        ${g}
                        <span class="message-time">${$(e.created_at)}</span>
                        ${h}
                    </li>
                `}s.add(e.id)}}),m&&p&&(c.insertAdjacentHTML("beforeend",m),S(),L(o,l,i),T())}document.addEventListener("DOMContentLoaded",()=>{_(),setInterval(()=>{y()},3e4),I()});function _(){"Notification"in window&&Notification.permission!=="granted"&&Notification.permission!=="denied"&&M(),q()}function M(){if(document.querySelector(".notification-permission-banner"))return;const t=document.createElement("div");t.className="notification-permission-banner",t.innerHTML=`
        <div class="notification-banner-content">
            <p>Разрешите уведомления, чтобы быть в курсе новых сообщений</p>
            <button id="allow-notifications" class="btn btn-primary">Разрешить</button>
            <button id="close-notification-banner" class="btn btn-secondary">Позже</button>
        </div>
    `,document.body.appendChild(t),document.getElementById("allow-notifications").addEventListener("click",()=>{E(),t.remove()}),document.getElementById("close-notification-banner").addEventListener("click",()=>{t.remove(),localStorage.setItem("notification_permission_asked",Date.now())})}function I(){const t=new URLSearchParams(window.location.search),n=t.get("chatId"),s=t.get("chatType");n&&s&&setTimeout(()=>{const o=document.querySelector(`[data-chat-id="${n}"][data-chat-type="${s}"]`);o&&o.click()},1e3)}function q(){document.addEventListener("click",function(t){t.target&&t.target.closest(".notifications-icon")&&y()})}export{T as a,$ as f,A as r};
