import"./firebase-init-WlDQV2z_.js";function v(i,s,a){document.querySelectorAll(".delete-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${s}/${a}/messages/${r}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":i,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{t.success?this.closest("li").remove():alert(t.error||"Ошибка удаления сообщения")}).catch(t=>console.error("Ошибка:",t))}}),document.querySelectorAll(".pin-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${s}/${a}/messages/${r}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":i,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let n=this.closest("li");if(n.classList.add("pinned"),n&&!n.querySelector(".pinned-label")){let o=document.createElement("span");o.classList.add("pinned-label"),o.textContent=" [Закреплено]",n.querySelector("div").appendChild(o)}filterMessages()}else console.error("Ошибка закрепления сообщения:",t.error),alert(t.error||"Ошибка закрепления сообщения")}).catch(t=>{console.error("Ошибка при закреплении сообщения:",t)})}}),document.querySelectorAll(".unpin-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${s}/${a}/messages/${r}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":i,"Content-Type":"application/json"}}).then(t=>t.json()).then(t=>{if(t.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let n=this.closest("li");n.classList.remove("pinned");let o=n.querySelector(".pinned-label");o&&o.remove(),filterMessages()}else alert(t.error||"Ошибка открепления сообщения")}).catch(t=>console.error("Ошибка:",t))}})}function $(i){return new Date(i).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function f(i){const s={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return i.replace(/[&<>"']/g,a=>s[a])}function E(){const i=document.getElementById("chat-messages");i.scrollTop=i.scrollHeight}function L(i){document.querySelectorAll("#chat-messages ul li").forEach(s=>{s.style.display=i?s.classList.contains("pinned")?"":"none":""})}function S(i,s,a,l,r,t){const n=document.getElementById("chat-messages");if(!n){console.error("Элемент chat-messages не найден!");return}const o=n.querySelector("ul");if(!o){console.error("Список сообщений не найден в chat-messages!");return}let m="",p=!1;i.forEach(e=>{if(!a.has(e.id)){if(p=!0,e.message_type==="notification"||e.is_system)m+=`
                    <li class="system-notification" data-id="${e.id}">
                        ${e.message}
                        <span class="message-time">${$(e.created_at)}</span>
                    </li>
                `;else{const u=e.sender_id===s,b=e.message_type==="notification"?"notification-message":u?"my-message":"other-message",y=e.is_pinned?"pinned":"";let h="";u&&e.is_read&&(h='<span class="read-status">✓✓</span>');let d="";e.message&&e.message.trim()!==""&&(e.message_type==="notification"?d+=e.message:d+=`<div>${f(e.message)}</div>`),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&e.attachments.forEach(c=>{c&&c.mime&&c.mime.startsWith("image/")?d+=`<div><img src="${c.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:c&&c.url&&(d+=`<div><a href="${c.url}" target="_blank">${f(c.original_file_name||"Файл")}</a></div>`)}),d.trim()===""&&(d='<div style="color:#888;">[Пустое сообщение]</div>');let g="";u&&(g=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${e.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${e.is_pinned?`<button class="unpin-message" data-id="${e.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${e.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),m+=`
                    <li class="${b} ${y}" data-id="${e.id}">
                        <div><strong>${u?"Вы":f(e.sender_name||"Неизвестно")}</strong></div>
                        ${d}
                        ${g}
                        <span class="message-time">${$(e.created_at)}</span>
                        ${h}
                    </li>
                `}a.add(e.id)}}),m&&p&&(o.insertAdjacentHTML("beforeend",m),E(),v(l,r,t),L())}document.addEventListener("DOMContentLoaded",()=>{if("Notification"in window&&Notification.permission!=="granted"&&Notification.permission!=="denied"){const i=document.createElement("div");i.className="notification-permission-banner",i.innerHTML=`
            <div class="notification-banner-content">
                <p>Разрешите уведомления, чтобы быть в курсе новых сообщений</p>
                <button id="allow-notifications" class="btn btn-primary">Разрешить</button>
                <button id="close-notification-banner" class="btn btn-secondary">Позже</button>
            </div>
        `,document.body.appendChild(i),document.getElementById("allow-notifications").addEventListener("click",()=>{Notification.requestPermission().then(s=>{console.log("Пользователь "+(s==="granted"?"разрешил":"не разрешил")+" уведомления"),i.remove()})}),document.getElementById("close-notification-banner").addEventListener("click",()=>{i.remove()})}});export{L as a,$ as f,S as r};
